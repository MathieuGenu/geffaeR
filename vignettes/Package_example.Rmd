---
title: "Preparation of data, CDS and kriging"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
vignette: >
  %\VignetteIndexEntry{Preparation of data, CDS and kriging}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



## Introduction
When a lot of distance sampling campaign are made, analysis have to be done to estimate abundance with tools such as distance, dsm, kriging. But from a campaign to another, the objectives are not always the same, while the method remains the same.

Ex : For a particular campaign, we want a cds analysis for all the campaign but for species a and b. For the other campaign we want a cds analysis for each session of the campaign for species b and c. So there are specificities that will be managed by the user but the method can be set to be generic and put in a package, so we don't have to modify the method for every campaign (illustrated fig1).

```{r, fig.cap = "fig1 : Analysis of observation campaign before and after the creation of geffaeR", echo = F, fig.retina = 3, out.width = '75%'}
knitr::include_graphics("before_after_EN_total.png")
```


This package proposes functions to manipulate observation campaign for the estimation of abondance indexes by using several tools for different type of analysis, such as :

* CDS analysis (Coventional Distance Sampling) using Distance package ([Distance](https://CRAN.R-project.org/package=Distance))
* Kriging
* CDS analysis using Stan ([rstan](https://CRAN.R-project.org/package=rstan))
* DSM (Density Surface Modelling) using dsm package ([dsm](https://CRAN.R-project.org/package=dsm))
<br>
<br>

This vignette presents :

1. Data preparation
2. CDS analysis
3. Kriging


# 1. Data Preparation

Analysis are performed on data collected with [SAMMOA](https://www.codelutin.com/page-detail-sammoa.html) software. This software allows observers to collect data while there are in aircraft or on boat. The outputs of this software are structured as below:

* Observation 
```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(geffaeR)
library(tidyverse)
library(DT)
htmltools::div(
  observation_example %>% 
  datatable(options = list(pageLength = 5, scrollX = T), width = 700)
)
```

* Effort
```{r, echo = FALSE}
library(geffaeR)
library(tidyverse)
library(DT)
htmltools::div(
  effort_example %>% 
  datatable(options = list(pageLength = 5, scrollX = T), width = 700)
)
```
<br>
<br>


## 1.1 change column names

To perform analysis on thoose data, it is necessary to modify its column name to match the need of packages (Distance, dsm). To do so, there are 2 functions ```change_effort_varName()``` and ```change_obs_varName()```.


## 1.2 Prepare data

Then, it is necessary to modify the data structure in a way to have the proper sub-dataframe for distance function. For this, effort dataframe is devided into 2 sub-dataframes :

* dataframe at leg scale
* dataframe at segment scale
```{r}
standard_effort <- change_effort_varName(effort_example)
prepared_effort <- prepare_data_effort(effort_base = standard_effort, 
                    shape = shape_example,
                    optimal = T,
                    block_area = data.frame(Block = c("ATL_N"), 
                                            Area = c(shape_example$area)), 
                    New_projection = lbrt93_proj,
                    covariable = NULL)
str(prepared_effort)

```
Observation dataframe is splitted into 4 sub-dataframes.
```{r}
standard_obs <- change_obs_varName(observation_example)
sp1 <- unique(observation_example$species)[1]
legdata <- prepared_effort$legdata
segdata <- prepared_effort$segdata
projection <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

observation_output <- prepare_data_obs(sp = sp1, 
                                       obs_base = standard_obs, 
                                       legdata = legdata, 
                                       segdata = segdata, 
                                       shape = shape_example, 
                                       shape_layer = shape_layer, 
                                       projection = projection)
str(observation_output)
```



# 2. cds analysis

When data are prepared the next step consist in adjusting a detection function on the data with the function ```plot_detection()```. It is possible to choose betwwen a half-normal function or hazard-rate one. It is necessary to inform the distance between which we want to perform the function.

```{r}
detection_TURTRU <- plot_detection(distdata = observation_output$distdata,
                            bin = seq(0.0,1.0, 0.05),
                            key = "halfnorm",
                            upper = 1.0)
```

This function as several outputs, it gives : the esw (effective strip width),
```{r}
detection_TURTRU$esw
```

its standard deviation (CV),
```{r}
detection_TURTRU$esw_cv
```

the output of distance function from the package [Distance](https://CRAN.R-project.org/package=Distance)
```{r}
detection_TURTRU$distFit
```
```{r}
summary(detection_TURTRU$distFit)
```

and gives the detetction plot (graph)
```{r}
detection_TURTRU$graph
```

