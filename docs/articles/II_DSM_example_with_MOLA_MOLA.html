<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>II. DSM example with MOLA MOLA • geffaeR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="II. DSM example with MOLA MOLA">
<meta property="og:description" content="geffaeR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-000000-01"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-000000-01');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geffaeR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/II_DSM_example_with_MOLA_MOLA.html">II. DSM example with MOLA MOLA</a>
    </li>
    <li>
      <a href="../articles/I_Preparation_of_data_CDS_and_kriging.html">I. Preparation of data and CDS</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="II_DSM_example_with_MOLA_MOLA_files/header-attrs-2.4/header-attrs.js"></script><script src="II_DSM_example_with_MOLA_MOLA_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="II_DSM_example_with_MOLA_MOLA_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>II. DSM example with MOLA MOLA</h1>
            
      
      
      <div class="hidden name"><code>II_DSM_example_with_MOLA_MOLA.Rmd</code></div>

    </div>

    
    
<p>Density Surface Modelling (DSM) consist in adjusting a Generalized Additive Model (GAM) on count data, while taking simultaneously into account imperfect detection (with distance sampling data) and covariates to obtain smoothed spatial maps of density. Once a model is adjusted, if its fit to the data is good enough, it can be used to predict the response variable (density of animals) over large areas, and possibly outside of the surveyed area.</p>
<p>geffaeR uses the <a href="https://github.com/DistanceDevelopment/dsm">DSM</a> package where ore information and a clear explanation on the use of Density Surface Models can be found (e.g. <a href="http://distancesampling.org/R/vignettes/mexico-analysis.html" class="uri">http://distancesampling.org/R/vignettes/mexico-analysis.html</a>). In this vignette it is presented how to fit a simple DSM with geffaeR and what is needed to do it applied on an applied example.</p>
<p>The vignette is organized in two main parts:</p>
<ol style="list-style-type: decimal">
<li>Data presentation</li>
<li>DSM with geffaeR</li>
</ol>
<div id="data-presentation" class="section level1">
<h1 class="hasAnchor">
<a href="#data-presentation" class="anchor"></a>1.Data presentation</h1>
<p>To illustrate how to fit DSMs in geffaeR, it is proposed to use the <strong>DSM_pack_MOLMOL</strong> included as data within geffaeR. It consist in a list of list bringing together all files needed for a DSM analysis.</p>
<pre><code>#&gt; List of 2
#&gt;  $ legdata:'data.frame': 1704 obs. of  11 variables:
#&gt;  $ segdata:'data.frame': 3354 obs. of  19 variables:
#&gt; List of 1
#&gt;  $ plot_detectionMOLMOL:List of 1
#&gt;   ..$ all_session:List of 4
#&gt;   .. ..$ graph  :List of 9
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "gg" "ggplot"
#&gt;   .. ..$ esw    : num [1:3] 0.15 0.147 0.155
#&gt;   .. ..$ esw_cv : num 2.7
#&gt;   .. ..$ distFit:List of 2
#&gt;   .. .. ..- attr(*, "class")= chr "dsmodel"
#&gt; List of 1
#&gt;  $ MOLMOL_obs_output:List of 5
#&gt;   ..$ distdata     :'data.frame':    3259 obs. of  18 variables:
#&gt;   ..$ obsdata      :'data.frame':    2072 obs. of  9 variables:
#&gt;   ..$ countdata_leg:'data.frame':    517 obs. of  4 variables:
#&gt;   ..$ countdata_seg:'data.frame':    779 obs. of  5 variables:
#&gt;   ..$ trunc        : num 1
#&gt; List of 1
#&gt;  $ : chr "MOLMOL"
#&gt; Classes 'sf' and 'data.frame':   84554 obs. of  18 variables:
#&gt;  $ Id        : num  1 1 2 2 3 3 4 4 5 5 ...
#&gt;  $ distCot   : num  22.14 22.14 3.16 3.16 8.6 ...
#&gt;  $ dist200   : num  135 135 156 156 152 ...
#&gt;  $ distCanyon: num  338 338 309 309 309 ...
#&gt;  $ Slope_1   : num  12000 12000 22147 22147 4243 ...
#&gt;  $ depth     : num  27 27 17 17 25 25 26 26 26 26 ...
#&gt;  $ Slope     : num  12000 12000 22147 22147 4243 ...
#&gt;  $ SlopePerce: num  0.012 0.012 0.02215 0.02215 0.00424 ...
#&gt;  $ session_  : Factor w/ 4 levels "1winter","2summer",..: 1 2 1 2 1 2 1 2 1 2 ...
#&gt;  $ CHL_month : num  NA NA NA NA NA NA NA NA NA NA ...
#&gt;  $ SeaHeight_: num  NA NA NA NA NA NA NA NA NA NA ...
#&gt;  $ SLA_month : num  NA NA NA NA NA NA NA NA NA NA ...
#&gt;  $ CHL_clim  : num  NA NA NA NA NA NA NA NA NA NA ...
#&gt;  $ SST_clim  : num  NA NA NA NA NA NA NA NA NA NA ...
#&gt;  $ POINT_X   : num  1455167 1455167 1435162 1435162 1439163 ...
#&gt;  $ POINT_Y   : num  6495464 6495464 6493729 6493729 6494076 ...
#&gt;  $ Area      : num  16 16 16 16 16 16 16 16 16 16 ...
#&gt;  $ geometry  :sfc_POINT of length 84554; first list element:  'XY' num  12.6 45.1
#&gt;  - attr(*, "sf_column")= chr "geometry"
#&gt;  - attr(*, "agr")= Factor w/ 3 levels "constant","aggregate",..: NA NA NA NA NA NA NA NA NA NA ...
#&gt;   ..- attr(*, "names")= chr  "Id" "distCot" "dist200" "distCanyon" ...</code></pre>
<div id="what-is-this-bizarre-fish" class="section level2">
<h2 class="hasAnchor">
<a href="#what-is-this-bizarre-fish" class="anchor"></a>What Is This Bizarre Fish?</h2>
<p>The sunfish, <em>Mola mola</em>, is a marine fish species that can reach up to 1 ton! It can live in temperate and tropical waters. It have a particular shape that makes it easy to recognize :</p>
<p><img src="Mola_mola.jpg" width="250px"></p>
<p>There are some speculations that sunfish densities in the oceans have increased, but the evidence is scarce and indirect. Here the aim is to estimate the density of sunfish is the North-Western Mediterranean Sea.</p>
</div>
<div id="how" class="section level2">
<h2 class="hasAnchor">
<a href="#how" class="anchor"></a>How ?</h2>
<p>The data were collected during the SAMM surveys (<em>Suivi Aérien de la Mégafaune Marine</em>, <a href="https://www.observatoire-pelagis.cnrs.fr/observatoire/Suivi-en-mer/suivi-aerien/" class="uri">https://www.observatoire-pelagis.cnrs.fr/observatoire/Suivi-en-mer/suivi-aerien/</a>) in 2011 and 2012. These surveys consist in flying over the sea in a plane (equiped with bubble windows) at a height of <span class="math inline">\(180\)</span> metres above sea level and at a speed of <span class="math inline">\(180\)</span> kilometers per hour along pre-defined transects. As the transects are flown over, two observers on either side of the plane scan the sea surface for sightings of marine megafauna.</p>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/global%20view-1.png" width="700"></p>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/map%20observation%20effort-1.png" width="50%"><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/map%20observation%20effort-2.png" width="50%"></p>
</div>
<div id="when" class="section level2">
<h2 class="hasAnchor">
<a href="#when" class="anchor"></a>When ?</h2>
<p>The SAMM surveys were carried out twice so far but in this vignette, only data from 2011 and 2012 will be used: 2011, 2012. These data correspond to two seasons: winter and summer.</p>
</div>
</div>
<div id="dsm" class="section level1">
<h1 class="hasAnchor">
<a href="#dsm" class="anchor"></a>2. DSM</h1>
<p>To fit some simple DSM with geffaeR, <span class="math inline">\(4\)</span> objects are necessary:</p>
<ul>
<li>segdata (output of <code>prepare_effort()</code>)</li>
<li>shape (shape of the study area)</li>
<li>observation (countdata_leg and contdata_seg outputs of <code>prepare_obs()</code>)</li>
<li>esw / distFit : output of <code><a href="../reference/plot_detection.html">plot_detection()</a></code>
</li>
</ul>
<p>To also predict, a fifth object will be needed:</p>
<ul>
<li>gridata (sf object)</li>
</ul>
<p>The object collates all the locations at which we may want to predict sunfish densities from a fitted DSM.</p>
<p><span class="math inline">\(6\)</span> functions in geffaeR are used in the DSM process (and <span class="math inline">\(1\)</span> is optional for using a soap smooth, dashed in the flowchart below) :</p>
<p><img src="DSM_functions.png" width="50%" style="display: block; margin: auto;"></p>
<div id="simple-dsm-with-geffaer" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-dsm-with-geffaer" class="anchor"></a>2.1 Simple DSM with geffaeR</h2>
<div id="prepare-predata-and-segdata-for-dsm" class="section level3">
<h3 class="hasAnchor">
<a href="#prepare-predata-and-segdata-for-dsm" class="anchor"></a>Prepare predata and segdata for DSM</h3>
<p>The first step consist in imputing missing values of covariates of segdata and gridata. Missing data imputation is done either using the Amelia package (<a href="https://cran.r-project.org/web/packages/Amelia/index.html" class="uri">https://cran.r-project.org/web/packages/Amelia/index.html</a>) or the missMDA package (<a href="https://cran.r-project.org/web/packages/missMDA/" class="uri">https://cran.r-project.org/web/packages/missMDA/</a>). Missing data imputation is used to ensure that a complete dataset with no missing values for any of the covariates will be used during model fitting. It is up to the user to check that the imputed values are realistic and plausible. Here we will consider two physiographic covariates, seafloor depth and distance to the nearest coastline, and one environmental covariate, chlorophyll a concentration averaged over a month. We can choose to use a logarithm transformation during missing data imputation to ensure that only positive values will be imputed. Here the missMDA package is used by specifying imputation = “PCA” below.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">geffaeR</span>)

<span class="co"># get segdata</span>
<span class="no">segdata</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">effort_output</span>$<span class="no">segdata</span>

<span class="co"># get grid</span>
<span class="no">grid</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">gridata</span>

<span class="co"># get shape </span>
<span class="no">shape</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">shape_med</span>

<span class="no">predata_output</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prep_predata.html">prep_predata</a></span>(<span class="kw">segdata</span> <span class="kw">=</span> <span class="no">segdata</span>,
                               <span class="kw">gridfile_name</span> <span class="kw">=</span> <span class="no">grid</span>,
                               <span class="kw">varenviro</span> <span class="kw">=</span> <span class="st">"CHL_month"</span>,
                               <span class="kw">do_log_enviro</span> <span class="kw">=</span> <span class="st">"CHL_month"</span>,
                               <span class="kw">varphysio</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"depth"</span>,<span class="st">"distCot"</span>),
                               <span class="kw">do_log_physio</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"depth"</span>, <span class="st">"distCot"</span>),
                               <span class="kw">imputation</span> <span class="kw">=</span> <span class="st">"PCA"</span>,
                               <span class="kw">shape</span> <span class="kw">=</span> <span class="no">shape</span>,
                               <span class="kw">verbose</span> <span class="kw">=</span> <span class="no">F</span>
                               )
<span class="co">#&gt; missing data in grid and segdata must be as NAs and nothing else (not 0)</span>
<span class="co">#&gt; although coordinates are longitude/latitude, st_intersects assumes that they are planar</span>
<span class="co">#&gt; although coordinates are longitude/latitude, st_intersects assumes that they are planar</span>
<span class="co">#&gt; There are 38 cells with missing values in segdata </span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; There are 343 cells with missing values in predata </span>
<span class="co">#&gt; </span></pre></body></html></div>
<p>The output of a call to this function is a wee bit complicated:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">predata_output</span>, <span class="kw">max.level</span> <span class="kw">=</span> <span class="fl">1</span>)
<span class="co">#&gt; List of 6</span>
<span class="co">#&gt;  $ predata   :'data.frame':  21182 obs. of  8 variables:</span>
<span class="co">#&gt;  $ segdata   :'data.frame':  3354 obs. of  17 variables:</span>
<span class="co">#&gt;  $ pca_seg   :List of 5</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr [1:2] "PCA" "list "</span>
<span class="co">#&gt;  $ pca_pred  :List of 5</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr [1:2] "PCA" "list "</span>
<span class="co">#&gt;  $ seg_mipat :List of 3</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr "summary.aggr"</span>
<span class="co">#&gt;  $ pred_mipat:List of 3</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr "summary.aggr"</span></pre></body></html></div>
<ul>
<li>predata : gridata with only covariates, coordinates and cells size (Area column)</li>
<li>segdata : segdata</li>
<li>pca_seg : output of PCA function on segdata (eig, coord on axis, …)</li>
<li>pca_pred : output of PCA function on predata (gridata) (eig, coord on axis, …)</li>
<li>seg_mipat : extended infos on missing values of covariates in segdata</li>
<li>pred_mipat : extended infos on missing values of covariates in predata</li>
</ul>
</div>
<div id="add-observations-on-segdata" class="section level3">
<h3 class="hasAnchor">
<a href="#add-observations-on-segdata" class="anchor"></a>Add observations on segdata</h3>
<p>Once a complete dataset for covariates is available and satisfactory, sightings of the species of interest, namely the sunfish can be join to these data. Note that the effort data here has been segmented in a pre-processing step. The function to join sightings to the covariate data is named, pardon my French! <em>ajout_obs</em>:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">effort_w_obs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ajout_obs.html">ajout_obs</a></span>(<span class="kw">countdata_leg</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">countdata_leg</span>,
                          <span class="kw">legdata</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">effort_output</span>$<span class="no">legdata</span>,
                          <span class="kw">countdata_seg</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">countdata_seg</span>,
                          <span class="kw">segdata</span> <span class="kw">=</span> <span class="no">predata_output</span>$<span class="no">segdata</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">effort_w_obs</span>, <span class="kw">max.level</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="co">#&gt; List of 2</span>
<span class="co">#&gt;  $ segdata_obs:'data.frame': 3354 obs. of  19 variables:</span>
<span class="co">#&gt;   ..$ Transect.Label: Factor w/ 297 levels "08a/101","08a/102",..: 129 129 129 129 129 129 129 129 129 130 ...</span>
<span class="co">#&gt;   ..$ Seg           : Factor w/ 5357 levels "1_1winter","10_1winter",..: 1 533 534 536 537 1112 2223 3334 4445 2 ...</span>
<span class="co">#&gt;   ..$ Sample.Label  : Factor w/ 2589 levels "1_1winter","10_1winter",..: 1 2362 2363 2364 2364 1 1112 1813 1924 2368 ...</span>
<span class="co">#&gt;   ..$ date          : Date[1:3354], format: "2011-12-01" "2012-05-21" ...</span>
<span class="co">#&gt;   ..$ survey        : Factor w/ 2 levels "ASI","SAMM": 2 2 2 2 2 2 2 2 2 2 ...</span>
<span class="co">#&gt;   ..$ Effort        : num [1:3354] 11.5 12.81 9.09 10.9 10.9 ...</span>
<span class="co">#&gt;   ..$ X             : num [1:3354] 1066262 1064795 1054794 1055798 1065737 ...</span>
<span class="co">#&gt;   ..$ Y             : num [1:3354] 6301700 6300892 6296430 6296876 6301347 ...</span>
<span class="co">#&gt;   ..$ longitude     : num [1:3354] 7.55 7.53 7.4 7.41 7.54 ...</span>
<span class="co">#&gt;   ..$ latitude      : num [1:3354] 43.7 43.7 43.7 43.7 43.7 ...</span>
<span class="co">#&gt;   ..$ Region.Label  : Factor w/ 9 levels "MED_08a","MED_08b",..: 6 6 6 6 6 6 6 6 6 6 ...</span>
<span class="co">#&gt;   ..$ seaState      : int [1:3354] 3 1 2 2 2 3 3 3 1 2 ...</span>
<span class="co">#&gt;   ..$ Area          : num [1:3354] 22560 22560 22560 22560 22560 ...</span>
<span class="co">#&gt;   ..$ subjective    : Factor w/ 19 levels "EE","EG","EM",..: 6 6 6 8 8 6 6 6 6 6 ...</span>
<span class="co">#&gt;   ..$ depth         : num [1:3354] 335 343 363 480 343 ...</span>
<span class="co">#&gt;   ..$ distCot       : num [1:3354] 5 6 3.61 4.12 6 ...</span>
<span class="co">#&gt;   ..$ CHL_month     : num [1:3354] 0.344 0.181 0.191 0.137 0.133 ...</span>
<span class="co">#&gt;   ..$ n             : num [1:3354] 0 0 1 1 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;   ..$ y             : num [1:3354] 0 0 1 1 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ legdata_obs:'data.frame': 1704 obs. of  13 variables:</span>
<span class="co">#&gt;   ..$ Transect.Label: Factor w/ 297 levels "08a/101","08a/102",..: 129 129 129 129 129 129 129 130 130 130 ...</span>
<span class="co">#&gt;   ..$ Sample.Label  : Factor w/ 2589 levels "1_1winter","10_1winter",..: 1 1112 1813 1924 2362 2363 2364 2 2257 2365 ...</span>
<span class="co">#&gt;   ..$ survey        : Factor w/ 2 levels "ASI","SAMM": 2 2 2 2 2 2 2 2 2 2 ...</span>
<span class="co">#&gt;   ..$ Region.Label  : Factor w/ 9 levels "MED_08a","MED_08b",..: 6 6 6 6 6 6 6 6 6 6 ...</span>
<span class="co">#&gt;   ..$ left          : Factor w/ 18 levels "AB","AC","AM",..: 3 13 13 13 3 3 8 3 3 3 ...</span>
<span class="co">#&gt;   ..$ right         : Factor w/ 20 levels "AB","AC","AM",..: 14 3 3 9 17 17 4 1 14 17 ...</span>
<span class="co">#&gt;   ..$ session       : Factor w/ 4 levels "1winter","2summer",..: 1 1 1 1 2 2 2 1 1 2 ...</span>
<span class="co">#&gt;   ..$ Effort        : num [1:1704] 22.99 1.36 5.94 12.99 12.81 ...</span>
<span class="co">#&gt;   ..$ seaState      : int [1:1704] 3 3 3 1 1 2 2 2 3 1 ...</span>
<span class="co">#&gt;   ..$ subjective    : Factor w/ 19 levels "EE","EG","EM",..: 6 6 6 6 6 6 8 6 8 6 ...</span>
<span class="co">#&gt;   ..$ Area          : num [1:1704] 22560 22560 22560 22560 22560 ...</span>
<span class="co">#&gt;   ..$ n_detected    : num [1:1704] 0 0 0 0 0 1 1 2 0 10 ...</span>
<span class="co">#&gt;   ..$ n_ind         : num [1:1704] 0 0 0 0 0 1 1 2 0 10 ...</span></pre></body></html></div>
<p>The dataframe segdata in effort_w_obs has now two additional 2 column: one called “n” corresponding to the number of sightings made on segment of effort; and “y” corresponding to the total number of individuals counted.</p>
</div>
<div id="fit-all-possible-model" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-all-possible-model" class="anchor"></a>Fit all possible model</h3>
<p>The next step consist in fitting all possible models and choose the best model to use for DSM with <code>fit_all_dsm</code> function. The minimum requirements to use this function are :</p>
<ul>
<li>segdata completed (output of <code>prep_predata</code>) and with observation (output of <code>ajout_obs</code>).</li>
<li>distFit or esw (outputs of <code>plot_detection</code>, see the vignette ???)</li>
<li>obsdata</li>
<li>predictors : covariates of segdata which will be used to fit gam models.</li>
</ul>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># get segdata_completed_w_obs</span>
<span class="no">segdata_completed_w_obs</span> <span class="kw">&lt;-</span> <span class="no">effort_w_obs</span>$<span class="no">segdata_obs</span>

<span class="co"># get distFit</span>
<span class="no">distFit</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_plot_detection_MOLMOL</span>$<span class="no">plot_detectionMOLMOL</span>$<span class="no">all_session</span>$<span class="no">distFit</span>

<span class="co"># get obsdata</span>
<span class="no">obsdata</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">obsdata</span>

<span class="co"># get covariates on which we fit gam model (predictors)</span>
<span class="no">predictors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CHL_month"</span>, <span class="st">"distCot"</span>, <span class="st">"depth"</span>)

<span class="co"># fit models</span>
<span class="no">fit_dsm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fit_all_dsm.html">fit_all_dsm</a></span>(<span class="kw">distFit</span> <span class="kw">=</span> <span class="no">distFit</span>,
                       <span class="kw">segdata_obs</span> <span class="kw">=</span> <span class="no">segdata_completed_w_obs</span>,
                       <span class="kw">obsdata</span> <span class="kw">=</span> <span class="no">obsdata</span>,
                       <span class="kw">predictors</span> <span class="kw">=</span> <span class="no">predictors</span>
                       )
<span class="co">#&gt;  * Response variable is the number of individuals</span>
<span class="co">#&gt;  * Detection function provided</span>
<span class="co">#&gt;  * Fitting all possible models, please wait</span>
<span class="co">#&gt;  * Using AIC for model selection</span>
<span class="co">#&gt;  * Estimating loocv on k best models: please wait</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are slightly high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are slightly high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are slightly high. See help('pareto-k-diagnostic') for details.</span></pre></body></html></div>
<p>A call to fit_all_dsm() yields as output a table that sums up model fitting according to different indicators and 2 list of the k best models (5 by default) sorted by their “stacking_weights”. Both lists are the same but one has standardized covariates (that is mean-centered and unit-variance, labelled best_models) and the other has the raw values (best_models4plotting, which will be used for plotting purposes).</p>
<pre><code>#&gt; Warning: le package 'kableExtra' a été compilé avec la version R 3.6.2
#&gt; 
#&gt; Attachement du package : 'kableExtra'
#&gt; The following object is masked from 'package:dplyr':
#&gt; 
#&gt;     group_rows</code></pre>
<table class="table table">
<thead><tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:right;">
index
</th>
<th style="text-align:right;">
Convergence
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
ResDev
</th>
<th style="text-align:right;">
NulDev
</th>
<th style="text-align:right;">
ExpDev
</th>
<th style="text-align:right;">
stacking_weights
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
count~ te(longitude, latitude, bs = ‘cs’) +s(CHL_month, k = 4, bs = ‘cs’) + s(distCot, k = 4, bs = ‘cs’)
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6203.360
</td>
<td style="text-align:right;">
1807.225
</td>
<td style="text-align:right;">
2160.803
</td>
<td style="text-align:right;">
16.4
</td>
<td style="text-align:right;">
0.1034205
</td>
</tr>
<tr>
<td style="text-align:left;">
count~ te(longitude, latitude, bs = ‘cs’) +s(CHL_month, k = 4, bs = ‘cs’) + s(depth, k = 4, bs = ‘cs’)
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6204.752
</td>
<td style="text-align:right;">
1805.386
</td>
<td style="text-align:right;">
2156.313
</td>
<td style="text-align:right;">
16.3
</td>
<td style="text-align:right;">
0.0566959
</td>
</tr>
<tr>
<td style="text-align:left;">
count~ te(longitude, latitude, bs = ‘cs’) +s(CHL_month, k = 4, bs = ‘cs’)
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6204.778
</td>
<td style="text-align:right;">
1806.174
</td>
<td style="text-align:right;">
2155.712
</td>
<td style="text-align:right;">
16.2
</td>
<td style="text-align:right;">
0.6030632
</td>
</tr>
<tr>
<td style="text-align:left;">
count~ te(longitude, latitude, bs = ‘cs’) +s(distCot, k = 4, bs = ‘cs’)
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6222.264
</td>
<td style="text-align:right;">
1804.929
</td>
<td style="text-align:right;">
2128.215
</td>
<td style="text-align:right;">
15.2
</td>
<td style="text-align:right;">
0.2368190
</td>
</tr>
<tr>
<td style="text-align:left;">
count ~ te(longitude, latitude, bs = ‘cs’)
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6225.529
</td>
<td style="text-align:right;">
1804.515
</td>
<td style="text-align:right;">
2120.993
</td>
<td style="text-align:right;">
14.9
</td>
<td style="text-align:right;">
0.0000015
</td>
</tr>
<tr>
<td style="text-align:left;">
count~ te(longitude, latitude, bs = ‘cs’) +s(depth, k = 4, bs = ‘cs’)
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6225.649
</td>
<td style="text-align:right;">
1803.691
</td>
<td style="text-align:right;">
2121.118
</td>
<td style="text-align:right;">
15.0
</td>
<td style="text-align:right;">
NA
</td>
</tr>
</tbody>
</table>
</div>
<div id="visualize-splines" class="section level3">
<h3 class="hasAnchor">
<a href="#visualize-splines" class="anchor"></a>visualize splines</h3>
<p>One does want to visualize splines of each variable fitted with <code>fit_all_dsm</code>, and it is possible with <code>pred_splines</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># get first model of fit_dsm</span>
<span class="no">fit_dsm_1</span> <span class="kw">&lt;-</span><span class="no">fit_dsm</span>$<span class="no">best_models4plotting</span><span class="kw">[[</span><span class="fl">1</span>]]

<span class="no">splines</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pred_splines.html">pred_splines</a></span>(
  <span class="kw">segdata</span> <span class="kw">=</span> <span class="no">segdata_completed_w_obs</span>,
  <span class="kw">dsm_model</span> <span class="kw">=</span> <span class="no">fit_dsm_1</span>
)

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">splines</span>, <span class="kw">max.level</span> <span class="kw">=</span> <span class="fl">1</span>)
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ df_splines:'data.frame':  4000 obs. of  6 variables:</span>
<span class="co">#&gt;  $ g_splines :List of 9</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr [1:2] "gg" "ggplot"</span>
<span class="co">#&gt;  $ spatial   :'data.frame':  20000 obs. of  6 variables:</span>
<span class="co">#&gt;   ..- attr(*, "out.attrs")=List of 2</span></pre></body></html></div>
<!-- Décrire ce qu'il y a dans les outputs de pred_splines -->
<ul>
<li>g_splines : correspond to the ggplot graph that gives splines of each variable of the model.</li>
<li>df_splines : a data.frame to be used for further plotting if needs be</li>
</ul>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Visualize variable splines</span>
<span class="no">splines</span>$<span class="no">g_splines</span></pre></body></html></div>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div id="predict-all-models-of-fit_all_dsm" class="section level3">
<h3 class="hasAnchor">
<a href="#predict-all-models-of-fit_all_dsm" class="anchor"></a>Predict all models of fit_all_dsm</h3>
<p>This step consists in getting predicted values from models fitted with the output of fit_all_dsm.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># get predata</span>
<span class="no">predata</span> <span class="kw">&lt;-</span> <span class="no">predata_output</span>$<span class="no">predata</span>

<span class="no">predicted_models</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/predict_all.html">predict_all</a></span>(
  <span class="kw">listdsm</span> <span class="kw">=</span> <span class="no">fit_dsm</span>,
  <span class="kw">predata</span> <span class="kw">=</span> <span class="no">predata</span>
)
<span class="co">#&gt;  * Predicting from 5 best models: please wait</span>
<span class="co">#&gt;  * Stacking predictions and done ;)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">predicted_models</span>)
<span class="co">#&gt; 'data.frame':    127092 obs. of  4 variables:</span>
<span class="co">#&gt;  $ mean : num  0.0178 0.0202 0.0193 0.0212 0.0179 ...</span>
<span class="co">#&gt;  $ se   : num  0.0106 0.012 0.0114 0.0124 0.0104 ...</span>
<span class="co">#&gt;  $ cv   : num  0.597 0.594 0.59 0.587 0.582 0.581 0.573 0.571 0.521 0.52 ...</span>
<span class="co">#&gt;  $ model: chr  "stacking" "stacking" "stacking" "stacking" ...</span></pre></body></html></div>
<p><code>predict_all</code> gives a data.frame of predicted values and standard error of the k best models of <code>fit_all_dsm</code> with a weighted combination of the k best named ‘stacking’ in the model column. By default, stacking is used on the <em>5</em> models with the smallest AIC.</p>
</div>
<div id="prediction-map" class="section level3">
<h3 class="hasAnchor">
<a href="#prediction-map" class="anchor"></a>Prediction map</h3>
<p><code>predict_map</code> allows to visualize prediction of <code>predict_all</code>.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># get combination of all models  </span>
<span class="no">pred_stack</span> <span class="kw">&lt;-</span> <span class="no">predicted_models</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">model</span> <span class="kw">==</span> <span class="st">"stacking"</span>)


<span class="co"># Set predata as sf object </span>
<span class="no">predata_custom</span> <span class="kw">&lt;-</span> <span class="no">predata</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">stack_pred</span> <span class="kw">=</span> <span class="no">pred_stack</span>$<span class="no">mean</span>) <span class="kw">%&gt;%</span>
  <span class="fu">st_as_sf</span>(<span class="kw">coords</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="kw">crs</span> <span class="kw">=</span> <span class="fl">4326</span>)


<span class="co"># Build prediction map</span>
<span class="no">map_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pred_map_dsm.html">pred_map_dsm</a></span>(
  <span class="kw">predata</span> <span class="kw">=</span> <span class="no">predata_custom</span>,
  <span class="kw">grid</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">gridata</span> <span class="kw">%&gt;%</span>
    <span class="fu">st_transform</span>(<span class="st">"+proj=aea +lat_1=43 +lat_2=62 +lat_0=30 +lon_0=10 +x_0=0 +y_0=0 +ellps=intl +units=m +no_defs"</span>),
  <span class="kw">var</span> <span class="kw">=</span> <span class="st">"stack_pred"</span>,
  <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Density prediction of "</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">italic</a></span>(<span class="st">"Mola mola"</span>), <span class="st">" for 2011 and 2012 during SAMM campaign"</span>))
  <span class="co"># title = "Density prediction of Mola mola for 2011 and 2012 during SAMM campaign"</span>
)

<span class="no">map_pred</span></pre></body></html></div>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
</div>
<div id="adding-a-categorical-variable" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-a-categorical-variable" class="anchor"></a>2.2 Adding a categorical variable</h2>
<p>The sampling occurred during 2 seasons (summer and winter) and we can expect difference in sunfish densities between summer and winter. Covariate effects may also be different between winter and summer, and we may want to allow for this possibility during modelling.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">stringr</span>)

<span class="co"># get distdata</span>
<span class="no">distdata</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">distdata</span>

<span class="co"># map of Mola mola occurence per season</span>
<span class="no">distdata</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">detected</span> <span class="kw">!=</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">session</span> <span class="kw">=</span> <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span>(<span class="no">session</span>, <span class="st">"[:alpha:]+"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Y</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">size</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="no">size</span>)) +
  <span class="fu">geom_sf</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">NEA_simplified_FR</span> <span class="kw">%&gt;%</span> <span class="fu">st_as_sf</span>(), <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu">aes</span>()) +
  <span class="fu">coord_sf</span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">12</span>), <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">40</span>,<span class="fl">45</span>)) +
  <span class="fu">facet_grid</span>(<span class="no">.</span>~<span class="no">session</span>) +
  <span class="fu">scale_colour_viridis_c</span>() +
  <span class="fu">theme_bw</span>()</pre></body></html></div>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>What has to be added to the simple DSM process ?</p>
<ul>
<li>
<code>prep_predata</code> with col2keep = “session”</li>
<li>
<code>fit_all_dsm</code> with splines_by = “session”</li>
<li>
<code>pred_splines</code> with splines_by = “session”</li>
<li>
<code>pred_map_dsm</code> with facet_param = “session”</li>
</ul>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">geffaeR</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)

<span class="co"># get segdata</span>
<span class="no">segdata</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">effort_output</span>$<span class="no">segdata</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">session</span> <span class="kw">=</span> <span class="fu">fct_drop</span>(<span class="no">session</span>))


<span class="co"># get grid</span>
<span class="no">grid</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">gridata</span> <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">session</span> <span class="kw">=</span> <span class="no">session_</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">session</span> <span class="kw">=</span> <span class="fu">fct_drop</span>(<span class="no">session</span>))

<span class="co"># get shape </span>
<span class="no">shape</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">shape_med</span>

<span class="co"># build predata outputs</span>
<span class="no">predata_output</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prep_predata.html">prep_predata</a></span>(<span class="kw">segdata</span> <span class="kw">=</span> <span class="no">segdata</span>,
                               <span class="kw">gridfile_name</span> <span class="kw">=</span> <span class="no">grid</span>,
                               <span class="kw">varenviro</span> <span class="kw">=</span> <span class="st">"CHL_month"</span>,
                               <span class="kw">do_log_enviro</span> <span class="kw">=</span> <span class="st">"CHL_month"</span>,
                               <span class="kw">varphysio</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"depth"</span>, <span class="st">"distCot"</span>),
                               <span class="kw">do_log_physio</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"depth"</span>, <span class="st">"distCot"</span>),
                               <span class="kw">shape</span> <span class="kw">=</span> <span class="no">shape</span>,
                               <span class="kw">imputation</span> <span class="kw">=</span> <span class="st">"PCA"</span>,
                               <span class="kw">col2keep</span> <span class="kw">=</span> <span class="st">"session"</span>,
                               <span class="kw">verbose</span> <span class="kw">=</span> <span class="no">F</span>
                               )
<span class="co">#&gt; missing data in grid and segdata must be as NAs and nothing else (not 0)</span>
<span class="co">#&gt; although coordinates are longitude/latitude, st_intersects assumes that they are planar</span>
<span class="co">#&gt; although coordinates are longitude/latitude, st_intersects assumes that they are planar</span>
<span class="co">#&gt; There are 38 cells with missing values in segdata </span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; There are 343 cells with missing values in predata </span>
<span class="co">#&gt; </span>

<span class="no">effort_w_obs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ajout_obs.html">ajout_obs</a></span>(<span class="kw">countdata_leg</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">countdata_leg</span>,
                          <span class="kw">legdata</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">effort_output</span>$<span class="no">legdata</span>,
                          <span class="kw">countdata_seg</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">countdata_seg</span>,
                          <span class="kw">segdata</span> <span class="kw">=</span> <span class="no">predata_output</span>$<span class="no">segdata</span>)

<span class="co"># get segdata_completed_w_obs</span>
<span class="no">segdata_completed_w_obs</span> <span class="kw">&lt;-</span> <span class="no">effort_w_obs</span>$<span class="no">segdata_obs</span>

<span class="co"># get distFit</span>
<span class="no">distFit</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_plot_detection_MOLMOL</span>$<span class="no">plot_detectionMOLMOL</span>$<span class="no">all_session</span>$<span class="no">distFit</span>

<span class="co"># get obsdata</span>
<span class="no">obsdata</span> <span class="kw">&lt;-</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">list_prepare_obs_MOLMOL</span>$<span class="no">MOLMOL_obs_output</span>$<span class="no">obsdata</span>

<span class="co"># get covariates on which we fit gam model (predictors)</span>
<span class="no">predictors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CHL_month"</span>,<span class="st">"distCot"</span>,<span class="st">"depth"</span>)

<span class="co"># fit models</span>
<span class="no">fit_dsm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fit_all_dsm.html">fit_all_dsm</a></span>(<span class="kw">distFit</span> <span class="kw">=</span> <span class="no">distFit</span>,
                       <span class="kw">segdata_obs</span> <span class="kw">=</span> <span class="no">segdata_completed_w_obs</span>,
                       <span class="kw">obsdata</span> <span class="kw">=</span> <span class="no">obsdata</span>,
                       <span class="kw">predictors</span> <span class="kw">=</span> <span class="no">predictors</span>,
                       <span class="kw">splines_by</span> <span class="kw">=</span> <span class="st">"session"</span>
                       )
<span class="co">#&gt;  * Response variable is the number of individuals</span>
<span class="co">#&gt;  * Detection function provided</span>
<span class="co">#&gt;  * Fitting all possible models, please wait</span>
<span class="co">#&gt;  * Using AIC for model selection</span>
<span class="co">#&gt;  * Estimating loocv on k best models: please wait</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(z): production de NaN</span>

<span class="co">#&gt; Warning in log(z): production de NaN</span>

<span class="co">#&gt; Warning in log(z): production de NaN</span>

<span class="co">#&gt; Warning in log(z): production de NaN</span>

<span class="co">#&gt; Warning in log(z): production de NaN</span>

<span class="co">#&gt; Warning in log(z): production de NaN</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="co">#&gt; Warning in log(z): production de NaN</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning in log(mu): production de NaN</span>
<span class="co">#&gt; Warning: Relative effective sample sizes ('r_eff' argument) not specified.</span>
<span class="co">#&gt; For models fit with MCMC, the reported PSIS effective sample sizes and </span>
<span class="co">#&gt; MCSE estimates will be over-optimistic.</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are slightly high. See help('pareto-k-diagnostic') for details.</span>

<span class="co"># get first model of fit_dsm</span>
<span class="no">fit_dsm_1</span> <span class="kw">&lt;-</span> <span class="no">fit_dsm</span>$<span class="no">best_models4plotting</span><span class="kw">[[</span><span class="fl">1</span>]]

<span class="no">splines</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pred_splines.html">pred_splines</a></span>(
  <span class="kw">segdata</span> <span class="kw">=</span> <span class="no">segdata_completed_w_obs</span>,
  <span class="kw">dsm_model</span> <span class="kw">=</span> <span class="no">fit_dsm_1</span>,
  <span class="kw">splines_by</span> <span class="kw">=</span> <span class="st">"session"</span>
)

<span class="no">splines</span>$<span class="no">g_splines</span>
<span class="co">#&gt; [[1]]</span></pre></body></html></div>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-12-2.png" width="700"></p>
<p>Now we can visualize the differences between winter and summer in the estimated relationships with covariates. Predictions can also be made for each season.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sf</span>)
<span class="co"># get predata</span>
<span class="no">predata</span> <span class="kw">&lt;-</span> <span class="no">predata_output</span>$<span class="no">predata</span>

<span class="no">predicted_models</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/predict_all.html">predict_all</a></span>(
  <span class="kw">listdsm</span> <span class="kw">=</span> <span class="no">fit_dsm</span>,
  <span class="kw">predata</span> <span class="kw">=</span> <span class="no">predata</span>
)
<span class="co">#&gt;  * Predicting from 5 best models: please wait</span>
<span class="co">#&gt;  * Stacking predictions and done ;)</span>


<span class="co"># get combination of all models  </span>
<span class="no">pred_stack</span> <span class="kw">&lt;-</span> <span class="no">predicted_models</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">model</span> <span class="kw">==</span> <span class="st">"best_1"</span>)


<span class="co"># Set predata as sf object </span>
<span class="no">predata_custom</span> <span class="kw">&lt;-</span> <span class="no">predata</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">stack_pred</span> <span class="kw">=</span> <span class="no">pred_stack</span>$<span class="no">mean</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>(<span class="kw">coords</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="kw">crs</span> <span class="kw">=</span> <span class="fl">4326</span>)


<span class="co"># Build prediction map</span>
<span class="no">map_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pred_map_dsm.html">pred_map_dsm</a></span>(
  <span class="kw">predata</span> <span class="kw">=</span> <span class="no">predata_custom</span>,
  <span class="kw">grid</span> <span class="kw">=</span> <span class="no">DSM_pack_MOLMOL</span>$<span class="no">gridata</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_transform.html">st_transform</a></span>(<span class="st">"+proj=aea +lat_1=43 +lat_2=62 +lat_0=30 +lon_0=10 +x_0=0 +y_0=0 +ellps=intl +units=m +no_defs"</span>),
  <span class="kw">var</span> <span class="kw">=</span> <span class="st">"stack_pred"</span>,
  <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Density prediction of "</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">italic</a></span>(<span class="st">"Mola mola"</span>), <span class="st">" for 2011 and 2012 during SAMM campaign"</span>)),
  <span class="kw">facet_param</span> <span class="kw">=</span> <span class="st">"session"</span>
)

<span class="no">map_pred</span></pre></body></html></div>
<p><img src="II_DSM_example_with_MOLA_MOLA_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mathieu Genu, Matthieu Authier.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
